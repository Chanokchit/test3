<html lang="th">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
</head>
<script type="text/javascript">
    let time_scan = 8000;
    let error_count = 0;
    var uuid_device01 = '54F888C9-EFEF-68D2-B21D-A730AC675099'
    var uuid_service01 = ''
    var uuid_characteristic_read = ''
    var uuid_characteristic_write = ''

    function scanDevice() {
        try {
            webkit.messageHandlers.scanDevice.postMessage(time_scan);
        } catch(error) {
            alert('scanDevice ' + error)
        }
    }
    function getPrimaryService() {
      try {
        webkit.messageHandlers.OneChat_connectServiceByUUID.postMessage(uuid_device01);
      } catch(error) {
        alert('getPrimaryService ' + error)
      }
    }
    function getCharacteristic() {
      try {
        webkit.messageHandlers.getCharacteristic.postMessage(uuid_service01);
      } catch(error) {
        alert('getCharacteristic ' + error)
      }
    }

    function readCharacteristic() {
      try {
        webkit.messageHandlers.readCharacteristic.postMessage(uuid_characteristic_read);
      } catch(error) {
        alert('readCharacteristic ' + error)
      }
    }

    function writeCharacteristic() {
      try {
        webkit.messageHandlers.writeCharacteristic.postMessage({uuid: uuid_characteristic_write, data: document.getElementById("write_characteristic").value});
      } catch(error) {
        alert('writeCharacteristic ' + error)
      }
    }


    function oneChatBluetoothCallBackData(type, data) {
        let message = '';
        try {
            if (type == 'get_device_service') {
                let obj = JSON.parse(data);

                for (let i = 0; i < obj.data.length; i++) {
                    let d = obj.data[i];
                    let mfdata = 'N/A';
                    let m = {}, mx;
                    // if (d.bluetooth_name == 'fe_fern') {
                    //     try {
                    //         uuid_device01 = d.uuid
                    //         document.getElementById("uuid").innerHTML = uuid_device01;
                    //     }
                    //     catch(e) {
                    //         m = 'error'
                    //     }
                    // }else {
                    //     document.getElementById("uuid").innerHTML = 'no fefern';
                    // }
                    if (d.manufacturer_data) {
                        try {
                            mx = d.manufacturer_data.replace(/[{} ]/g,'');
                            let arr= mx.split(',');
                            for (let c of arr) {
                                let b = c.split('=');
                                m[b[0]] = b[1];
                            }

                            if (m) {
                                mfdata = m.bytes;
                            } 
                        }
                        catch(e) {
                            m = 'error'
                        }
                    }

                    //let xx = require('util').inspect(d, false, null true);
                    // raw : ${d.manufacturer_data}<br>
                    // m : ${m}<br>
                    // mx : ${mx}<br>

                    message += `
                        name : ${d.bluetooth_name}<br>
                        uuid : ${d.uuid}<br>
                        manufacturer_data : ${mfdata}<br>
                        state : ${d.state}<br>
                        rssi : ${d.rssi}<br>
                        -----------------------------------------------------<br>
                    `;
                }
                document.getElementById("devicelist").innerHTML=message;
            // } else if (type == 'get_device_service') {
            //      var obj = JSON.parse(data)
            //      var message = '<u>รายชื่ออุปกรณ์ </u><br/>'
            //      uuid_device01 = obj.data[0].uuid
            //      for (var i = 0; i < obj.data.length; i += 1) {
            //      message = message + '<p>' + obj.data[i].bluetooth_name + '</p>'
            //      }
            //      document.getElementById("listdevice").innerHTML=message;
            // }
            } else if (type == 'get_service') {
                // var obj = JSON.parse(data)
                // var message = '<u>รายชื่อบริการ </u><br/>'
                // uuid_service01 = obj.uuid[0]
                // for (var i = 0; i < obj.uuid.length; i += 1) {
                // message = message + '<p>' + obj.uuid[i] + '</p>'
                // if (obj.uuid[i] == 'AB10') {
                //     uuid_service01 = 'AB10'
                // }
                // }
                // let message = '';
                let obj = JSON.parse(data);

                for (let i = 0; i < obj.data.length; i++) {
                    let d = obj.data[i];
                    // let mfdata = 'N/A';
                    // let m = {}, mx;

                    message += `
                        name : ${d.device_name}<br>
                        uuid : ${d.device_uuid}<br>
                        data : ${data}<br>
                        -----------------------------------------------------<br>
                    `;
                }
                document.getElementById("listservice").innerHTML=message;
            }
            // } else if (type == 'get_characteristic') {
            //     var obj = JSON.parse(data)
            //     var message = '<u>รายชื่อcharacteristic</u><br/>'
            //     for (var i = 0; i < obj.data.length; i += 1) {
            //     message = message + '<p>' + obj.data[i].uuid + '(' + obj.data[i].type + ')</p>'
            //     if (obj.data[i].type == 'read') {
            //         uuid_characteristic_read = obj.data[i].uuid
            //     } else if (obj.data[i].type == 'write') {
            //         uuid_characteristic_write = obj.data[i].uuid
            //     }
            //     }
            //     document.getElementById("listcharacteristic").innerHTML=message;

            // } else if (type == 'read_characteristic') {
            //     alert(data)

            // } else if (type == 'write_characteristic') {
            //     alert(data)
            // }
        }
        catch(error) {
            if (error_count == 0) {
                alert(error);
            }
            error_count++;
        }        
    }

</script>
<body>
    <h1>
        <a href="javascript:getPrimaryService();">[ get device ]</a>
    </h1>
    <br/>
        <div id="listservice" width=300></textarea>
    <br/>
    <h1>
        <a href="javascript:scanDevice();">[ scan device ]</a>
    </h1>
    <br/>
        <div id="devicelist" width=300></textarea>
    <br/>
    
</body>
</html>
