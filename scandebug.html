<html lang="th">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
</head>
<script type="text/javascript">
    let time_scan = 50000;
    let error_count = 0;
    var uuid_device01 = '54F888C9-EFEF-68D2-B21D-A730AC675099'
    var uuid_service01 = '180D'
    var uuid_characteristic_read = ''
    var uuid_characteristic_write = '2A39'
    var datawrite = 'test-fern'

    function scanDevice() {
        try {
            webkit.messageHandlers.scanDevice.postMessage(time_scan);
        } catch(error) {
            alert('scanDevice ' + error)
        }
    }
    function getPrimaryService() {
      try {
        webkit.messageHandlers.OneChat_getPrimaryService.postMessage(uuid_device01);
      } catch(error) {
        alert('getPrimaryService ' + error)
      }
    }
    function getCharacteristic() {
      try {
        webkit.messageHandlers.OneChat_getCharacteristic.postMessage(uuid_service01);
      } catch(error) {
        alert('getCharacteristic ' + error)
      }
    }
    function writeCharacteristicByUUID() {
      try {
        webkit.messageHandlers.OneChat_writeCharacteristicByUUID.postMessage({device_uuid: uuid_device01 ,service_uuid: uuid_service01 ,characteristic_uuid: uuid_characteristic_write ,data: datawrite});
      } catch(error) {
        alert('writeCharacteristicByUUID ' + error)
      }
    }
    function writeCharacteristic() {
      try {
        webkit.messageHandlers.OneChat_writeCharacteristic.postMessage({uuid: uuid_characteristic_write, data: datawrite});
      } catch(error) {
        alert('writeCharacteristic ' + error)
      }
    }
    function readCharacteristic() {
      try {
        webkit.messageHandlers.readCharacteristic.postMessage(uuid_characteristic_read);
      } catch(error) {
        alert('readCharacteristic ' + error)
      }
    }

    // function writeCharacteristic() {
    //   try {
    //     webkit.messageHandlers.writeCharacteristic.postMessage({uuid: uuid_characteristic_write, data: document.getElementById("write_characteristic").value});
    //   } catch(error) {
    //     alert('writeCharacteristic ' + error)
    //   }
    // }


    function oneChatBluetoothCallBackData(type, data) {
        try {
            if (type == 'get_device_service') {
                let obj = JSON.parse(data);
                var message = ''
                for (let i = 0; i < obj.data.length; i++) {
                    let d = obj.data[i];
                    let mfdata = 'N/A';
                    let m = {}, mx;
                    // if (d.bluetooth_name == 'fe_fern') {
                    //     try {
                    //         uuid_device01 = d.uuid
                    //         document.getElementById("uuid").innerHTML = uuid_device01;
                    //     }
                    //     catch(e) {
                    //         m = 'error'
                    //     }
                    // }else {
                    //     document.getElementById("uuid").innerHTML = 'no fefern';
                    // }
                    if (d.manufacturer_data) {
                        try {
                            mx = d.manufacturer_data.replace(/[{} ]/g,'');
                            let arr= mx.split(',');
                            for (let c of arr) {
                                let b = c.split('=');
                                m[b[0]] = b[1];
                            }

                            if (m) {
                                mfdata = m.bytes;
                            } 
                        }
                        catch(e) {
                            m = 'error'
                        }
                    }

                    //let xx = require('util').inspect(d, false, null true);
                    // raw : ${d.manufacturer_data}<br>
                    // m : ${m}<br>
                    // mx : ${mx}<br>

                    message += `
                        name : ${d.bluetooth_name}<br>
                        uuid : ${d.uuid}<br>
                        manufacturer_data : ${mfdata}<br>
                        state : ${d.state}<br>
                        rssi : ${d.rssi}<br>
                        -----------------------------------------------------<br>
                    `;
                }
                document.getElementById("devicelist").innerHTML=message;

            } else if (type == 'get_service') {
                let obj = JSON.parse(data);
                var message = ''
                for (let i = 0; i < obj.data.length; i++) {
                    let a = obj.data[i];
                    // let mfdata = 'N/A';
                    // let m = {}, mx;

                    message += `
                        service : ${a}<br>
                        data : ${data}<br>
                        -----------------------------------------------------<br>
                    `;
                }
                document.getElementById("listservice").innerHTML=message;

            } else if (type == 'get_characteristic') {
                let obj = JSON.parse(data);
                var message = '123'
                document.getElementById("test").innerHTML="testget_characteristic>>>>", data;
                // for (let i = 0; i < obj.data.length; i++) {
                //     let d = obj.data[i];
                //     // let mfdata = 'N/A';
                //     // let m = {}, mx;

                //     message += `
                //         type : ${type}<br>
                //         characteristic : ${d}<br>
                //         data : ${data}<br>
                //         -----------------------------------------------------<br>
                //     `;
                // }
                document.getElementById("listcharacteristic").innerHTML=message;

            } else if (type == 'write_characteristic_by_uuid') {
                alert (data)
                document.getElementById("test").innerHTML="testwrite_characteristic_by_uuid";
                let obj = JSON.parse(data);
                var message = ''
                for (let i = 0; i < obj.data.length; i++) {
                    let a = obj.data[i];
                    // let mfdata = 'N/A';
                    // let m = {}, mx;

                    message += `
                        string : ${a}<br>
                        data : ${data}<br>
                        -----------------------------------------------------<br>
                    `;
                }
                document.getElementById("writecharacteristic2").innerHTML=message;
            // else if (type == 'write_characteristic') {
            //     let obj2 = JSON.parse(data);

            //     for (let i = 0; i < obj2.data.length; i++) {
            //         let c = obj2.data[i];
            //         // let mfdata = 'N/A';
            //         // let m = {}, mx;

            //         message4 += `
            //             characteristic : ${c}<br>
            //             data : ${data}<br>
            //             name : ${c.type}<br>
            //             uuid : ${c.service_uuid}<br>
            //             data : ${c.data}<br>
            //             data : ${data}<br>
            //             -----------------------------------------------------<br>
            //         `;
            //     }
            //     document.getElementById("listwrite").innerHTML=message4;
            // }
            // } else if (type == 'get_characteristic') {
            //     var obj = JSON.parse(data)
            //     var message = '<u>รายชื่อcharacteristic</u><br>'
            //     for (var i = 0; i < obj.data.length; i += 1) {
            //     message = message + '<p>' + obj.data[i].uuid + '(' + obj.data[i].type + ')</p>'
            //     if (obj.data[i].type == 'read') {
            //         uuid_characteristic_read = obj.data[i].uuid
            //     } else if (obj.data[i].type == 'write') {
            //         uuid_characteristic_write = obj.data[i].uuid
            //     }
            //     }
            //     document.getElementById("listcharacteristic").innerHTML=message;

            // } else if (type == 'read_characteristic') {
            //     alert(data)

            // } else if (type == 'write_characteristic') {
            //     alert(data)
            // }
        }}
        catch(error) {
            alert('>>>>>>>>' + error);

            if (error_count == 0) {
                alert(error);
            }
            error_count++;
        }        
    }

</script>
<body>
    <span id="test">test</span>
    <br>
    <h1>
        <a href="javascript:writeCharacteristicByUUID();">[ write ]</a>
    </h1>
    <br>
        <div id="writecharacteristic2" width=300></div>
    <br>
    <h1>
        <a href="javascript:getCharacteristic();">[ get Characteristic ]</a>
    </h1>
    <br>
        <div id="listcharacteristic" width=300></div>
    <br>
    <br>
        
        <!-- <div id="test" width=300></div> -->
    <br>
    <h1>
        <a href="javascript:getPrimaryService();">[ get service ]</a>
    </h1>
    <br>
        <div id="listservice" width=300></div>
    <br>
    <h1>
        <a href="javascript:scanDevice();">[ scan device ]</a>
    </h1>
    <br>
        <div id="devicelist" width=300></div>
    <br>
    
</body>
</html>
