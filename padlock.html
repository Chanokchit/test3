<html lang="th">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <script src="https://chat-develop.one.th/static/javascript/v1/onechat_bluetooth.js"></script>
</head>
<script type="text/javascript">

    let time_scan = 20000;
    let device_uuid = '';
    let device_uuid2 = 'A658ED45-BA23-BE46-5482-E1B5205D922A';
    let num = '';
    // var uuid_device = '9B29E7FC-0C99-C207-1B7A-A4EF0A871B73'
    var service_uuid2 = '0000FFD5-0000-1000-8000-00805F9B34FB'
    var characteristic_uuid2 = '0000FFD9-0000-1000-8000-00805F9B34FB'
    var service_uuid = 'FFD5'
    var characteristic_uuid = 'FFD9'
    var data_1 = '2905050505050528'
    var data_1_1 = '2901020304010228'
    var data_2 = 'FE4F50454E00000000FD'
    // var uuid_characteristic_write = characteristic_uuid
    // var data_type = 'hex'
    // var data_type2 = 'text'
    // var datawrite = '2901010101010128'
    // var datawrite2 = data_2

    function logtoHTML(input, header = ''){

    let out = input;
    if (typeof(input) == 'object') {
      try {
          out =  JSON.stringify(input, undefined, 4);
      }
      catch(e) {
          alert(e);
      }
    }

    let debugbox = document.getElementById("devicelist");
    if (debugbox) {
      if (header) {
          header = ' '+header+' ';
      }
      debugbox.innerHTML = out + '<br>---'+ header +'-------------------------<br>' + document.getElementById("devicelist").innerHTML;
    }
}

    function scanDevice() {
          try {
              num = 1;
              OneChat_scanDevice(time_scan);
            //   OneChat_connectServiceByUUID(device_uuid, service_uuid)
              setTimeout(() => {
                        logtoHTML('1>>>>' + device_uuid);
                        OneChat_writeCharacteristicByUUID(device_uuid, service_uuid, characteristic_uuid, data_1_1, 'hex');
                        
                        setTimeout(() => {
                        logtoHTML('2>>>>' + device_uuid);
                        OneChat_writeCharacteristic(characteristic_uuid, data_2, 'hex')
                        // OneChat_writeCharacteristicByUUID(device_uuid, service_uuid, characteristic_uuid, data_2, 'hex');
                                  }, 10000);
                        }, 8000);
          }
          catch(error) {
        	    alert('scanDevice ' + error);
          }
      }
    //   function marwan() {
    //       try {
    //           num = 1;
    //           OneChat_scanDevice(time_scan);
    //         //   OneChat_connectServiceByUUID(device_uuid, service_uuid)
    //           setTimeout(() => {
    //                     logtoHTML('1>>>>' + device_uuid);
    //                     OneChat_writeCharacteristicByUUID(device_uuid, service_uuid2, characteristic_uuid2, data_1, 'hex');
                        
    //                  /*   setTimeout(() => {
    //                     logtoHTML('2>>>>' + device_uuid);
    //                     OneChat_writeCharacteristicByUUID(device_uuid, service_uuid2, characteristic_uuid2, data_2, 'hex');
    //                               }, 8000);*/
                                  
    //                     setTimeout(() => {
    //                         OneChat_disconnectBluetoothByUUID(device_uuid);

    //                         logtoHTML("disconnected");
    //                     }, 30000);       

    //                     }, 5000);
                        
    //       }

      function marwan() {
          try {
              num = 1;
              OneChat_scanDevice(time_scan);
            //   OneChat_connectServiceByUUID(device_uuid, service_uuid)
              setTimeout(() => {
                        logtoHTML('1>>>>' + device_uuid + 'service>>>>' + service_uuid + 'charac>>>' + characteristic_uuid + 'data >>>>' + data_1_1);
                        OneChat_writeCharacteristicByUUID(device_uuid, service_uuid, characteristic_uuid, data_1_1, 'hex');
                        
                        // setTimeout(() => {
                        // logtoHTML('2>>>>' + device_uuid);
                        // OneChat_writeCharacteristicByUUID(device_uuid, service_uuid2, characteristic_uuid2, data_2, 'hex');
                        //           }, 8000);
                        setTimeout(() => {
                            OneChat_disconnectBluetoothByUUID(device_uuid);

                            logtoHTML("disconnected");
                        }, 30000);  
                        }, 6000);
          }
          catch(error) {
        	    alert('scanDevice ' + error);
          }
      }
      function marwan2() {
          try {
              num = 1;
              OneChat_scanDevice(time_scan);
            //   OneChat_connectServiceByUUID(device_uuid, service_uuid)
              setTimeout(() => {
                        logtoHTML('1>>>>' + device_uuid);
                        OneChat_writeCharacteristicByUUID(device_uuid, service_uuid2, characteristic_uuid2, data_1, 'hex');
                        
                        setTimeout(() => {
                        logtoHTML('2>>>>' + device_uuid);
                        OneChat_writeCharacteristicByUUID(device_uuid, service_uuid2, characteristic_uuid2, data_2, 'hex');
                                  }, 8000);
                        }, 8000);
          }
          catch(error) {
        	    alert('scanDevice ' + error);
          }
      }
      function fern() {
          try {
              OneChat_scanDevice(time_scan);
              setTimeout(() => {
                        logtoHTML('1>>>>' + device_uuid2);
                        OneChat_writeCharacteristicByUUID(device_uuid2, '180D', '2A39', '2905050505050528', 'hex');

                        setTimeout(() => {
                        logtoHTML('2>>>>' + device_uuid2);
                        OneChat_writeCharacteristicByUUID(device_uuid2, '180D', '2A39', 'FE4F50454E00000000FD', 'hex');
                                  }, 8000);
                        }, 8000);
          }
          catch(error) {
        	    alert('scanDevice ' + error);
          }
      }
      function scanDevice2() {
          try {
              num = 2;
              OneChat_scanDevice(time_scan);
              OneChat_connectServiceByUUID(device_uuid, service_uuid)
          }
          catch(error) {
        	    alert('scanDevice ' + error);
          }
      }
      function writepassword_uuid() {
          try {
            // setTimeout(() => {
                num = 1;
                OneChat_scanDevice(time_scan);

                setTimeout(() => {
                    logtoHTML('1>>>>' + device_uuid);
                    OneChat_writeCharacteristicByUUID(device_uuid, service_uuid, characteristic_uuid, data_1, 'hex');
                        }, 5000);
          }
          catch(error) {
        	    alert('write ' + error);
          }
      }
      function writepassword_uuid2() {
          try {
            // setTimeout(() => {
                logtoHTML('2>>>>' + device_uuid);
                OneChat_writeCharacteristicByUUID(device_uuid, service_uuid, characteristic_uuid, data_2, 'hex');
                        // }, 8000);
          }
          catch(error) {
        	    alert('write ' + error);
          }
      }
      function write1() {
          try {
            // setTimeout(() => {
                logtoHTML('1 >>>>' + device_uuid);
                OneChat_writeCharacteristic(characteristic_uuid, data_1, 'hex')
                        // }, 8000);
          }
          catch(error) {
        	    alert('write ' + error);
          }
      }
      function write2() {
          try {
            // setTimeout(() => {
                logtoHTML('2 >>>>' + device_uuid);
                OneChat_writeCharacteristic(characteristic_uuid, data_2, 'hex')
                        // }, 8000);
          }
          catch(error) {
        	    alert('write ' + error);
          }
      }

      function disconnect() {
          try {
            OneChat_disconnectBluetoothByUUID(device_uuid);
          }
          catch(error) {
        	    alert('disconnect ' + error);
          }
      }


    window.addEventListener('oneChatBluetoothCallBackData',  async(e) => {
        let message = '';

        let type = e.detail.type;
        logtoHTML ('*** type >>>>>' + type)
        let datastr = e.detail.data;
        let data;

        try {
            data = JSON.parse(datastr);
        }
        catch(e) {
            data = {};
        }

        try {
            if (type == 'return_once_device') {
                    let d = data.data;
                    logtoHTML(d);                    
                    if (d.bluetooth_name == 'LOCK-10082C3FA29C') {
                        let uuid = d.uuid
                        device_uuid = uuid
                            // if (num == 2){
                            //     OneChat_getPrimaryService(device_uuid)
                            // }
                        logtoHTML('num >>>>' + num);
                        OneChat_stopScanDevice();
                    // } else if (d.bluetooth_name == 'fern') {
                    //     let uuid = d.uuid
                    //     device_uuid = uuid
                    //     OneChat_stopScanDevice();
                    }
                    else if (d.bluetooth_name == 'LOCK-10082C3F8A1D') {
                        let uuid = d.uuid
                        device_uuid = uuid
                        // if (num == 2){
                        //     OneChat_getPrimaryService(device_uuid)
                        // }
                        logtoHTML('num >>>>' + num);
                        OneChat_stopScanDevice();
                    // } else if (d.bluetooth_name == 'fern') {
                    //     let uuid = d.uuid
                    //     device_uuid = uuid
                    //     OneChat_stopScanDevice();
                    }
                    // if (d.bluetooth_name == 'LOCK-999999999998') {
                    //     let uuid = d.uuid
                    //     device_uuid = uuid
                    //     // if (num == 2){
                    //     //     OneChat_getPrimaryService(device_uuid)
                    //     // }
                    //     logtoHTML('num >>>>' + num);
                    //     OneChat_stopScanDevice();
                    // // } else if (d.bluetooth_name == 'fern') {
                    // //     let uuid = d.uuid
                    // //     device_uuid = uuid
                    // //     OneChat_stopScanDevice();
                    // }

            } else if (type == 'get_service') {
                let d = data.data;
                    logtoHTML('service uuid >>>>>>' + d);
                    for (let i = 0; i < d.length; i++) {
                        let obj = d[i];
                        if (obj == service_uuid) {
                            OneChat_getCharacteristic(obj) 
                            logtoHTML('service uuid >>>>>>' + obj);
                        }
                    }

            } else if (type == 'get_characteristic') {
                    let d = data.data;
                    for (let i = 0; i < d.length; i++) {
                        let obj = d[i]

                        message += `
                            uuid : ${obj.uuid}<br>
                            type : ${obj.type}<br>
                            descriptors : ${obj.descriptors}<br>
                            -----------------------------------------------------<br>
                        `;
                    } logtoHTML('>>>>>>' + message);
                    

            } else if (type == 'write_characteristic_by_uuid') {
                logtoHTML('write by uuid');
                let d = data
                if (d) {

                        logtoHTML('writing by uuid >>>> ' + d.device_uuid)
                        logtoHTML('service >>>> ' + d.service_uuid )
                        logtoHTML('character >>>> ' + d.characteristic_uuid )
                        logtoHTML('data >>>> ' + d.data )

                        if (d.data == data_2) {
                            setTimeout(() => {
                                // OneChat_disconnectBluetoothByUUID(d.device_uuid);
                                logtoHTML("disconnecting...");
                            }, 5000);
                        }
                }
            
            } else if (type == 'write_characteristic') {
                logtoHTML('write');
                let a = data
                if (a) {
                        logtoHTML('character >>>> ' + a.characteristic_uuid )
                        logtoHTML('data >>>> ' + a.data )

                        if (a.data == data_2) {
                            setTimeout(() => {
                                OneChat_disconnectBluetoothByUUID(device_uuid);
                                logtoHTML("disconnecting...");
                            }, 10000);
                        }
                }

            } else if (type == 'disconnect_bluetooth_by_uuid') {
                logtoHTML("disconnected");
            }
        }
        catch(error) {

        }        
    });

</script>
<body>

    <h1>
        0.1 >>> <a href="javascript:fern();">[ Test ]</a>
    </h1>
    <h1>
        0.2 >>> <a href="javascript:marwan();">[ Test marwan - 1 data]</a>
    </h1>
    <h1>
        0.3 >>> <a href="javascript:marwan2();">[ Test marwan - 2 data ]</a>
    </h1>
    ---------------------------------------------------------------------------------------
    <h1>
        1. >>> <a href="javascript:scanDevice();">[ Open padlock -- write characteristic_uuid ]</a>
    </h1>
    ---------------------------------------------------------------------------------------
    <h1>
        2.1 >>> <a href="javascript:scanDevice2();">[ scan device ]</a>
    </h1>
    
    <h1>
        2.2 >>> <a href="javascript:write1();">[ write data 1 ]</a>
    </h1>
    <h1>
        2.3 >>> <a href="javascript:write2();">[ write data 2 ]</a>
    </h1>
    ---------------------------------------------------------------------------------------
    <h1>
        3.1 >>> <a href="javascript:writepassword_uuid();">[ write by uuid data 1 ]</a>
    </h1>
    <h1>
        3.1 >>> <a href="javascript:writepassword_uuid2();">[ write by uuid data 2 ]</a>
    </h1>
    ---------------------------------------------------------------------------------------
    <h1>
        disconnect >>> <a href="javascript:disconnect();">[ disconnect_bluetooth_by_uuid ]</a>
    </h1>
    ---------------------------------------------------------------------------------------
    <div id="devicelist" width=300></div>

</body>
</html>
