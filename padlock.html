<html lang="th">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <script src="https://chat-develop.one.th/static/javascript/v1/onechat_bluetooth.js"></script>
</head>
<script type="text/javascript">

    let time_scan = 10000;
    let device_uuid = '';
    let num = '';
    // var uuid_device = '9B29E7FC-0C99-C207-1B7A-A4EF0A871B73'
    // var uuid_service = 'ffd5'
    // var uuid_characteristic_read = '2A38'
    // var uuid_characteristic_write = 'ffd9'
    // var data_type = 'hex'
    // var data_type2 = 'text'
    // var datawrite = '2901010101010128'
    // var datawrite2 = 'fe4f50454e00000000fd'

    function logtoHTML(input, header = ''){

    let out = input;
    if (typeof(input) == 'object') {
      try {
          out =  JSON.stringify(input, undefined, 4);
      }
      catch(e) {
          alert(e);
      }
    }

    let debugbox = document.getElementById("devicelist");
    if (debugbox) {
      if (header) {
          header = ' '+header+' ';
      }
      debugbox.innerHTML = out + '<br>---'+ header +'-------------------------<br>' + document.getElementById("devicelist").innerHTML;
    }
}

    function scanDevice() {
          try {
              num = 1;
              OneChat_scanDevice(time_scan);
            //   OneChat_connectServiceByUUID(device_uuid, 'FFD5')
              setTimeout(() => {
                        logtoHTML('1>>>>' + device_uuid);
                        OneChat_writeCharacteristicByUUID(device_uuid, 'FFD5', 'FFD9', '2905050505050528', 'hex');
                        
                        setTimeout(() => {
                        logtoHTML('2>>>>' + device_uuid);
                        OneChat_writeCharacteristicByUUID(device_uuid, 'FFD5', 'FFD9', 'FE4F50454E00000000FD', 'hex');
                                  }, 8000);
                        }, 8000);
          }
          catch(error) {
        	    alert('scanDevice ' + error);
          }
      }
      function scanDevice2() {
          try {
              num = 2;
              OneChat_scanDevice(time_scan);
              OneChat_connectServiceByUUID(device_uuid, 'FFD5')
          }
          catch(error) {
        	    alert('scanDevice ' + error);
          }
      }
      function writepassword_uuid() {
          try {
            // setTimeout(() => {
                num = 1;
                OneChat_scanDevice(time_scan);

                logtoHTML('1>>>>' + device_uuid);
                OneChat_writeCharacteristicByUUID(device_uuid, 'FFD5', 'FFD9', '2905050505050528', 'hex');
                        // }, 8000);
          }
          catch(error) {
        	    alert('write ' + error);
          }
      }
      function writepassword_uuid2() {
          try {
            // setTimeout(() => {
                logtoHTML('2>>>>' + device_uuid);
                OneChat_writeCharacteristicByUUID(device_uuid, 'FFD5', 'FFD9', 'FE4F50454E00000000FD', 'hex');
                        // }, 8000);
          }
          catch(error) {
        	    alert('write ' + error);
          }
      }
      function write1() {
          try {
            // setTimeout(() => {
                logtoHTML('1 >>>>' + device_uuid);
                OneChat_writeCharacteristic('FFD9', '2905050505050528', 'hex')
                        // }, 8000);
          }
          catch(error) {
        	    alert('write ' + error);
          }
      }
      function write2() {
          try {
            // setTimeout(() => {
                logtoHTML('2 >>>>' + device_uuid);
                OneChat_writeCharacteristic('FFD9', 'FE4F50454E00000000FD', 'hex')
                        // }, 8000);
          }
          catch(error) {
        	    alert('write ' + error);
          }
      }


    window.addEventListener('oneChatBluetoothCallBackData',  async(e) => {
        let message = '';

        let type = e.detail.type;
        let datastr = e.detail.data;
        let data;

        try {
            data = JSON.parse(datastr);
        }
        catch(e) {
            data = {};
        }

        try {
            if (type == 'return_once_device') {
                    let d = data.data;
                    logtoHTML(d);                    
                    if (d.bluetooth_name == 'LOCK-10082C3FA29C') {
                        let uuid = d.uuid
                        device_uuid = uuid
                        if (num == 2){
                            OneChat_getPrimaryService(device_uuid)
                        }
                        logtoHTML('num >>>>' + num);
                        OneChat_stopScanDevice();
                    }

            } else if (type == 'get_service') {
                let d = data.data;
                    logtoHTML('service uuid >>>>>>' + d);
                    for (let i = 0; i < d.length; i++) {
                        let obj = d[i];
                        if (obj == 'FFD5') {
                            OneChat_getCharacteristic(obj) 
                            logtoHTML('service uuid >>>>>>' + obj);
                        }
                    }

            } else if (type == 'get_characteristic') {
                    let d = data.data;
                    for (let i = 0; i < d.length; i++) {
                        let obj = d[i]

                        message += `
                            uuid : ${obj.uuid}<br>
                            type : ${obj.type}<br>
                            descriptors : ${obj.descriptors}<br>
                            -----------------------------------------------------<br>
                        `;
                    } logtoHTML('>>>>>>' + message);
                    

            } else if (type == 'write_characteristic_by_uuid') {
                logtoHTML('write by uuid');
                let d = data
                if (d) {

                        logtoHTML('writing by uuid >>>> ' + d.device_uuid)
                        logtoHTML('service >>>> ' + d.service_uuid )
                        logtoHTML('character >>>> ' + d.characteristic_uuid )
                        logtoHTML('data >>>> ' + d.data )

                        if (d.data == 'FE4F50454E00000000FD') {
                            setTimeout(() => {
                                OneChat_disconnectBluetoothByUUID(d.device_uuid);
                                logtoHTML("disconnecting...");
                            }, 5000);
                        }
                }
            
            } else if (type == 'write_characteristic') {
                logtoHTML('write');
                let a = data
                if (a) {
                        logtoHTML('character >>>> ' + a.characteristic_uuid )
                        logtoHTML('data >>>> ' + a.data )

                        if (a.data == 'FE4F50454E00000000FD') {
                            setTimeout(() => {
                                OneChat_disconnectBluetoothByUUID(device_uuid);
                                logtoHTML("disconnecting...");
                            }, 5000);
                        }
                }

            } else if (type == 'disconnect_bluetooth_by_uuid') {
                logtoHTML("disconnected");
            }
        }
        catch(error) {

        }        
    });

</script>
<body>

    <h1>
        1. >>> <a href="javascript:scanDevice();">[ Open padlock -- write characteristic_uuid ]</a>
    </h1>
    ---------------------------------------------------------------------------------------
    <h1>
        2.1 >>> <a href="javascript:scanDevice2();">[ scan device ]</a>
    </h1>
    
    <h1>
        2.2 >>> <a href="javascript:write1();">[ write data 1 ]</a>
    </h1>
    <h1>
        2.3 >>> <a href="javascript:write2();">[ write data 2 ]</a>
    </h1>
    ---------------------------------------------------------------------------------------
    <h1>
        3.1 >>> <a href="javascript:writepassword_uuid();">[ write by uuid data 1 ]</a>
    </h1>
    <h1>
        3.1 >>> <a href="javascript:writepassword_uuid2();">[ write by uuid data 2 ]</a>
    </h1>
    <div id="devicelist" width=300></div>
    
</body>
</html>
